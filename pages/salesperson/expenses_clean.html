<!--
=========================================================
* Soft UI Dashboard 3 - v1.1.0
=========================================================

* Product Page: https://www.creative-tim.com/product/soft-ui-dashboard
* Copyright 2024 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../../assets/img/favicon.png">
  <title>
    Expense Management (Clean)
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- CSS Files -->
  <link id="pagestyle" href="../../assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />
  <!-- Nepcha Analytics (nepcha.com) -->
  <!-- Nepcha is a easy-to-use web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. -->
  <script defer data-site="YOUR_DOMAIN_HERE" src="https://api.nepcha.com/js/nepcha-analytics.js"></script>
</head>

<body class="g-sidenav-show  bg-gray-100">
  <script src="../../assets/js/config.js"></script> 
  <script>
    // Redirect to sign-in if not authenticated
    (function() {
      var token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '../sign-in.html';
      }
    })();
  </script>
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 " id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0"  target="_blank">
        
        <span class="ms-1 font-weight-bold">Sales Person Dashboard</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
       
        <li class="nav-item">
          <a class="nav-link" href="../salesperson/sales.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-chart-line text-dark"></i>
            </div>
            <span class="nav-link-text ms-1">Sales</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../salesperson/credit-management.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-credit-card text-dark"></i>
            </div>
            <span class="nav-link-text ms-1">Credit Management</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../salesperson/credit-customers.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-users text-dark"></i>
            </div>
            <span class="nav-link-text ms-1">Credit Customers</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../salesperson/customer-requests.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-user-tag text-dark"></i>
            </div>
            <span class="nav-link-text ms-1">Customer Requests</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="../salesperson/expenses_clean.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-money-bill-wave text-dark"></i>
            </div>
            <span class="nav-link-text ms-1">Expenses</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Expense Management</li>
          </ol>
          <h6 class="font-weight-bolder mb-0">Expense Management</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group">
             
            </div>
          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" id="signOutLink" class="nav-link text-body font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <!-- Add your dashboard content here -->
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>Expense Management</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <!-- Add your content here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Overview Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h4>Expenses</h4>
              <p class="text-sm text-secondary mb-0">Track and manage business expenses and cash withdraws</p>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Today's Expenses Card -->
                <div class="col-lg-4 col-md-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <div class="icon icon-shape icon-lg bg-gradient-primary shadow text-center border-radius-lg mb-3">
                        <i class="fas fa-calendar-day text-white opacity-10"></i>
                      </div>
                      <h5 class="mt-3">Today's Expenses</h5>
                      <h2 class="mb-0" id="todays-expenses">shs:</h2>
                    </div>
                  </div>
                </div>

                <!-- This Week's Expenses Card -->
                <div class="col-lg-4 col-md-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <div class="icon icon-shape icon-lg bg-gradient-warning shadow text-center border-radius-lg mb-3">
                        <i class="fas fa-calendar-week text-white opacity-10"></i>
                      </div>
                      <h5 class="mt-3">This Week</h5>
                      <h2 class="mb-0" id="weeks-expenses">shs:</h2>
                    </div>
                  </div>
                </div>

                <!-- This Month's Expenses Card -->
                <div class="col-lg-4 col-md-6 mb-4">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <div class="icon icon-shape icon-lg bg-gradient-success shadow text-center border-radius-lg mb-3">
                        <i class="fas fa-calendar-alt text-white opacity-10"></i>
                      </div>
                      <h5 class="mt-3">This Month</h5>
                      <h2 class="mb-0" id="months-expenses">shs:</h2>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- All Expenses Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h4>All Expenses</h4>
              <p class="text-sm text-secondary mb-0">Overview of expenses and withdraws</p>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-6">
                  <button class="btn bg-gradient-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="fas fa-plus me-2"></i>Add New Expense
                  </button>
                </div>
                <div class="col-6 d-flex justify-content-end">
                  <div class="input-group input-group-outline me-3" style="width: 250px; height: 45px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search Expense" id="searchExpenseInput">
                  </div>
                  <div class="dropdown">
                    <button class="btn bg-gradient-secondary dropdown-toggle" type="button" id="purposeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      Select Purpose
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="purposeDropdown">
                      <li><a class="dropdown-item" href="#">All</a></li>
                      <li><a class="dropdown-item" href="#">Transport</a></li>
                      <li><a class="dropdown-item" href="#">Supplies</a></li>
                      <li><a class="dropdown-item" href="#">Utilities</a></li>
                      <li><a class="dropdown-item" href="#">Other</a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Time</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Amount</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Purpose</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Source</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Action</th>
                    </tr>
                  </thead>
                  <tbody id="expensesTableBody">
                    <!-- Expenses will be loaded here -->
                  </tbody>
                </table>
              </div>
              <!-- Pagination Controls -->
              <div class="d-flex justify-content-between align-items-center mt-3 px-4">
                <div class="text-sm text-muted">
                  Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> expenses
                </div>
                <div class="d-flex align-items-center">
                  <button class="btn btn-sm btn-outline-secondary me-2" id="prevPage" disabled>
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span class="badge bg-primary px-3 py-2" id="currentPageInfo">Page 1</span>
                  <button class="btn btn-sm btn-outline-secondary ms-2" id="nextPage" disabled>
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Core JS Files -->
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../../assets/js/plugins/chartjs.min.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../../assets/js/soft-ui-dashboard.min.js?v=1.1.0"></script>
  <!-- ... existing code from expenses.html (modals, forms, etc.) ... -->

  <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addExpenseModalLabel"><i class="fas fa-plus-circle me-2 text-primary"></i>Add New Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="addExpenseForm" autocomplete="off">
          <div class="modal-body">
            <div class="card">
              <div class="card-header pb-2">
                <h6 class="mb-0"><i class="fas fa-receipt me-2 text-info"></i>Expense Details</h6>
              </div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label for="expenseDate" class="form-control-label">Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="expenseDate" name="date" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label for="expenseType" class="form-control-label">Expense Type <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="expenseType" name="type" value="Cash Expenditure" readonly disabled>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label for="expenseAmount" class="form-control-label">Amount <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <span class="input-group-text">shs:</span>
                        <input type="number" class="form-control" id="expenseAmount" name="amount" placeholder="Enter amount" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label for="expensePurpose" class="form-control-label">Purpose/Reason <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="expensePurpose" name="purpose" rows="3" placeholder="Enter purpose or reason" required></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Expense</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Optional: Reset form when modal is closed
    document.addEventListener('hidden.bs.modal', function (event) {
      if (event.target.id === 'addExpenseModal') {
        document.getElementById('addExpenseForm').reset();
      }
    });
    // Set current date when Add New Expense modal is shown
    document.addEventListener('DOMContentLoaded', function () {
      var addExpenseModal = document.getElementById('addExpenseModal');
      if (addExpenseModal) {
        addExpenseModal.addEventListener('show.bs.modal', function () {
          var dateInput = document.getElementById('expenseDate');
          if (dateInput) {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = yyyy + '-' + mm + '-' + dd;
          }
        });
      }

      // Add Expense form submission handler
      var addExpenseForm = document.getElementById('addExpenseForm');
      if (addExpenseForm) {
        addExpenseForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const date = document.getElementById('expenseDate').value;
          const amount = document.getElementById('expenseAmount').value;
          const purpose = document.getElementById('expensePurpose').value;

          const data = { date, amount, purpose };

          try {
            const response = await fetch(API_BASE_URL + '/api/expenses', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
              alert('Expense added successfully!');
              addExpenseForm.reset();
              // Close modal (Bootstrap 5)
              var modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseModal'));
              if (modal) modal.hide();
              // Reload the expenses table so the new record appears immediately
              loadExpenses(1);
              // Optionally, update the table here
            } else {
              alert('Error: ' + (result.message || 'Unknown error'));
            }
          } catch (error) {
            alert('Network error: ' + error.message);
          }
        });
      }
    });

    // Fetch and render expenses in the All Expenses table
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;
    const recordsPerPage = 4;
    let allExpensesCache = [];
    let filteredExpensesCache = [];
    let selectedPurpose = '';
    let expenseIdToDelete = null;

    function trimToFirstTwoWords(text) {
      if (!text) return '';
      const words = text.split(' ');
      if (words.length <= 2) return text;
      return words.slice(0, 2).join(' ') + '...';
    }

    function formatDate(dateStr) {
      // Only show date part (YYYY-MM-DD)
      return dateStr;
    }

    async function loadExpenses(page = 1, fetchAll = false) {
      try {
        // Always fetch all records for accurate client-side filtering and pagination
        let url = API_BASE_URL + `/api/expenses?page=1&limit=10000`;
        const response = await fetch(url);
        const data = await response.json();
        let expenses = data.expenses || [];
        // Filter to only current month
        const now = new Date();
        const currentYear = now.getUTCFullYear();
        const currentMonth = now.getUTCMonth(); // 0-based
        expenses = expenses.filter(exp => {
          const expDate = new Date(exp.expenditure_date || exp.date);
          return expDate.getUTCFullYear() === currentYear && expDate.getUTCMonth() === currentMonth;
        });
        // Update totalRecords and totalPages to reflect only current month
        totalRecords = expenses.length;
        totalPages = Math.ceil(totalRecords / recordsPerPage);
        allExpensesCache = expenses;
        // Paginate client-side
        const start = (page - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        renderExpensesTable(expenses.slice(start, end));
      } catch (error) {
        console.error('Failed to load expenses:', error);
        const tbody = document.getElementById('expensesTableBody');
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading expenses: ${error.message}</td></tr>`;
        updatePaginationInfo(0, 0, 0);
        updatePaginationControls();
      }
    }

    function updatePaginationInfo(startRecord, endRecord, total) {
      document.getElementById('startRecord').innerText = startRecord;
      document.getElementById('endRecord').innerText = endRecord;
      document.getElementById('totalRecords').innerText = total;
    }

    function updatePaginationControls() {
      const prevPage = document.getElementById('prevPage');
      const nextPage = document.getElementById('nextPage');
      const currentPageInfo = document.getElementById('currentPageInfo');
      prevPage.disabled = currentPage <= 1;
      nextPage.disabled = currentPage >= totalPages;
      currentPageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
    }

    document.getElementById('prevPage').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        if (selectedPurpose) {
          const start = (currentPage - 1) * recordsPerPage;
          const end = start + recordsPerPage;
          renderExpensesTable(filteredExpensesCache.slice(start, end));
          updatePaginationInfo(start + 1, Math.min(end, totalRecords), totalRecords);
          updatePaginationControls();
        } else {
          loadExpenses(currentPage);
        }
      }
    });
    document.getElementById('nextPage').addEventListener('click', function() {
      if (currentPage < totalPages) {
        currentPage++;
        if (selectedPurpose) {
          const start = (currentPage - 1) * recordsPerPage;
          const end = start + recordsPerPage;
          renderExpensesTable(filteredExpensesCache.slice(start, end));
          updatePaginationInfo(start + 1, Math.min(end, totalRecords), totalRecords);
          updatePaginationControls();
        } else {
          loadExpenses(currentPage);
        }
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      loadExpenses(currentPage);
      loadExpenseSummary();
      loadExpensePurposes();
      // Attach delete event listeners after rendering table
      document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-expense-btn')) {
          expenseIdToDelete = e.target.closest('.delete-expense-btn').getAttribute('data-id');
          const modal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
          modal.show();
        }
      });
      document.getElementById('confirmDeleteExpenseBtn').addEventListener('click', async function() {
        if (!expenseIdToDelete) return;
        try {
          const response = await fetch(API_BASE_URL + `/api/expenses/${expenseIdToDelete}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (response.ok) {
            alert('Expense deleted successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteExpenseModal'));
            if (modal) modal.hide();
            loadExpenses(currentPage);
          } else {
            alert('Error: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          alert('Network error: ' + error.message);
        }
        expenseIdToDelete = null;
      });
    });

    async function loadExpenseSummary() {
      try {
        const response = await fetch(API_BASE_URL + '/api/expenses/summary');
        const summary = await response.json();
        document.getElementById('todays-expenses').innerText = `shs:${Number(summary.today).toLocaleString()}`;
        document.getElementById('weeks-expenses').innerText = `shs:${Number(summary.week).toLocaleString()}`;
        document.getElementById('months-expenses').innerText = `shs:${Number(summary.month).toLocaleString()}`;
      } catch (error) {
        document.getElementById('todays-expenses').innerText = 'Error';
        document.getElementById('weeks-expenses').innerText = 'Error';
        document.getElementById('months-expenses').innerText = 'Error';
        console.error('Failed to load expense summary:', error);
      }
    }

    async function loadExpensePurposes() {
      try {
        const response = await fetch(API_BASE_URL + '/api/expenses/purposes');
        const data = await response.json();
        const purposes = data.purposes || [];
        const dropdown = document.querySelector('#purposeDropdown + .dropdown-menu');
        dropdown.innerHTML = '<li><a class="dropdown-item" href="#" data-purpose="">All</a></li>';
        purposes.forEach(purpose => {
          dropdown.innerHTML += `<li><a class="dropdown-item" href="#" data-purpose="${encodeURIComponent(purpose)}">${purpose}</a></li>`;
        });
        // Add click event listeners
        dropdown.querySelectorAll('.dropdown-item').forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedPurpose = decodeURIComponent(this.getAttribute('data-purpose'));
            document.getElementById('purposeDropdown').innerText = selectedPurpose || 'Select Purpose';
            filterExpensesByPurpose(selectedPurpose);
          });
        });
      } catch (error) {
        console.error('Failed to load purposes:', error);
      }
    }

    function applyPurposeFilter() {
      let filtered = allExpensesCache;
      if (selectedPurpose) {
        const matching = allExpensesCache.filter(e => e.purpose === selectedPurpose);
        const nonMatching = allExpensesCache.filter(e => e.purpose !== selectedPurpose);
        filtered = [...matching, ...nonMatching];
      }
      filteredExpensesCache = filtered;
      totalRecords = filtered.length;
      totalPages = Math.ceil(totalRecords / recordsPerPage);
      currentPage = 1;
      renderExpensesTable(filteredExpensesCache.slice(0, recordsPerPage));
      updatePaginationInfo(1, Math.min(recordsPerPage, totalRecords), totalRecords);
      updatePaginationControls();
    }

    function renderExpensesTable(expenses) {
      const tbody = document.getElementById('expensesTableBody');
      tbody.innerHTML = '';
      if (expenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-inbox me-2"></i>No expenses found</td></tr>`;
        updatePaginationInfo(0, 0, 0);
        updatePaginationControls();
        return;
      }
      expenses.forEach(exp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><p class="text-xs font-weight-bold mb-0 ps-3">${formatDate(exp.expenditure_date)}</p></td>
          <td><p class="text-xs font-weight-bold mb-0">shs:${parseFloat(exp.amount).toFixed(2)}</p></td>
          <td class="align-middle text-center text-sm">
            <span class="badge badge-sm bg-gradient-info">${trimToFirstTwoWords(exp.purpose)}</span>
          </td>
          <td><p class="text-xs font-weight-bold mb-0">${exp.expense_type}</p></td>
          <td class="align-middle text-center">
            <button class="btn btn-link text-secondary mb-0 edit-expense-btn" data-id="${exp._id}" data-amount="${exp.amount}" data-purpose="${exp.purpose}">
              <i class="fa fa-edit text-xs"></i>
            </button>
            <button class="btn btn-link text-danger mb-0 delete-expense-btn" data-id="${exp._id}">
              <i class="fa fa-trash text-xs"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // Attach event listeners for edit buttons
      document.querySelectorAll('.edit-expense-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const amount = this.getAttribute('data-amount');
          const purpose = this.getAttribute('data-purpose');
          document.getElementById('editExpenseAmount').value = amount;
          document.getElementById('editExpensePurpose').value = purpose;
          document.getElementById('editExpenseForm').setAttribute('data-id', id);
          const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
          modal.show();
        });
      });
      const startIndex = (currentPage - 1) * recordsPerPage + 1;
      const endIndex = Math.min(currentPage * recordsPerPage, totalRecords);
      updatePaginationInfo(startIndex, endIndex, totalRecords);
      updatePaginationControls();
    }

    function filterExpensesByPurpose(purpose) {
      selectedPurpose = purpose;
      if (!allExpensesCache.length) {
        loadExpenses(1, true);
      } else {
        applyPurposeFilter();
      }
    }

    // Make the dropdown scrollable
    const style = document.createElement('style');
    style.innerHTML = `.dropdown-menu { max-height: 250px; overflow-y: auto; }`;
    document.head.appendChild(style);

    // Live search for expenses by purpose
    document.getElementById('searchExpenseInput').addEventListener('input', async function (e) {
      const searchText = e.target.value.trim().toLowerCase();
      // If allExpensesCache is not fully loaded, fetch all expenses
      if (!allExpensesCache || allExpensesCache.length < totalRecords) {
        await loadExpenses(1, true);
      }
      let filtered = allExpensesCache;
      if (searchText) {
        filtered = allExpensesCache.filter(exp =>
          exp.purpose && exp.purpose.toLowerCase().includes(searchText)
        );
      }
      // If a purpose is also selected, filter further
      if (selectedPurpose) {
        filtered = filtered.sort((a, b) => {
          if (a.purpose === selectedPurpose && b.purpose !== selectedPurpose) return -1;
          if (a.purpose !== selectedPurpose && b.purpose === selectedPurpose) return 1;
          return 0;
        });
      }
      filteredExpensesCache = filtered;
      currentPage = 1;
      renderExpensesTable(filteredExpensesCache.slice(0, recordsPerPage));
      updatePaginationInfo(filteredExpensesCache.length ? 1 : 0, Math.min(recordsPerPage, filteredExpensesCache.length), filteredExpensesCache.length);
      totalRecords = filteredExpensesCache.length;
      totalPages = Math.ceil(totalRecords / recordsPerPage);
      updatePaginationControls();
    });
  </script>
  
  <!-- Edit Expense Modal -->
  <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editExpenseModalLabel"><i class="fas fa-edit me-2 text-warning"></i>Edit Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editExpenseForm" autocomplete="off">
          <div class="modal-body">
            <div class="card">
              <div class="card-header pb-2">
                <h6 class="mb-0"><i class="fas fa-receipt me-2 text-info"></i>Edit Expense Details</h6>
              </div>
              <div class="card-body">
                <div class="form-group mb-3">
                  <label class="form-control-label">Amount <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">shs:</span>
                    <input type="number" class="form-control" id="editExpenseAmount" name="amount" required>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label class="form-control-label">Purpose/Reason <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="editExpensePurpose" name="purpose" rows="3" required></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Handle Edit Expense form submission
    const editExpenseForm = document.getElementById('editExpenseForm');
    if (editExpenseForm) {
      editExpenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = editExpenseForm.getAttribute('data-id');
        const amount = document.getElementById('editExpenseAmount').value;
        const purpose = document.getElementById('editExpensePurpose').value;
        try {
          const response = await fetch(API_BASE_URL + `/api/expenses/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, purpose })
          });
          const result = await response.json();
          if (response.ok) {
            alert('Expense updated successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editExpenseModal'));
            if (modal) modal.hide();
            loadExpenses(currentPage);
          } else {
            alert('Error: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          alert('Network error: ' + error.message);
        }
      });
    }
  </script>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteExpenseModalLabel"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Delete Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to permanently delete this expense record?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteExpenseBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
  <script>
document.getElementById('signOutLink').addEventListener('click', function(e) {
  e.preventDefault();
  localStorage.removeItem('authToken'); // Remove the token on sign out
  window.location.href = '../sign-in.html';
});
</script>
</body>

</html> 